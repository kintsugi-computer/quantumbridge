<!doctype html>
<head>
    <title>QuantumBridge</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="worker-src 'self';">

    <!-- PWA Meta Tags -->
    <link rel="icon" href="/quantumbridge/favicon.png" sizes="48x48">
    <link rel="icon" href="/quantumbridge/icons/icon-192x192.png" type="image/png" sizes="192x192">
    <link rel="icon" href="/quantumbridge/icons/icon-512x512.png" type="image/png" sizes="512x512">
    <link rel="apple-touch-icon" href="/quantumbridge/icons/icon-180x180.png">
    <link rel="manifest" href="/quantumbridge/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QuantumBridge">

    <!-- iOS Splash Screens -->
    <!-- iPhone 16 Pro Max -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/quantumbridge/splash/splash-1290x2796.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/quantumbridge/splash/splash-2796x1290.png">

    <!-- iPhone 16 Pro / 15 -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/quantumbridge/splash/splash-1179x2556.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/quantumbridge/splash/splash-2556x1179.png">

    <!-- iPhone SE / 8 -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/quantumbridge/splash/splash-750x1334.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/quantumbridge/splash/splash-1334x750.png">

    <!-- iPad Pro 13" -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/quantumbridge/splash/splash-2048x2732.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/quantumbridge/splash/splash-2732x2048.png">

    <!-- iPad Pro 11" -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/quantumbridge/splash/splash-1668x2388.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/quantumbridge/splash/splash-2388x1668.png">

    <!-- iPad Air -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/quantumbridge/splash/splash-1640x2360.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/quantumbridge/splash/splash-2360x1640.png">

    <!-- iPad Mini -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/quantumbridge/splash/splash-1536x2048.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/quantumbridge/splash/splash-2048x1536.png">

    <style>
:root {
    --body-colour: #000000;
    --body-background: #ffffff;
    --disabled-button-background: #f0f0f0;
}

body {
    font-family: Arial, Helvetica, sans-serif;
    color: var(--body-colour);
    background-color: var(--body-background);
    text-align: center;
}

table {
    margin: 0 auto;
    display: table;
}

th {
    width: 8vw;
    font-size: 4vh;
    text-align: right;
}

td {
}

input[type=number] {
    text-align: right;
}

input[type=text] {
    text-align: center;
}

input {
    border: 0.5vh solid var{--body-colour};
    font-size: 4vh;
    height: 5vh;
    width: 18vw;
    color: var(--body-colour);
    background-color: var(--body-background);
}

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Firefox */
input[type=number] {
    -moz-appearance: textfield;
}

button {
    font-size: 4vh;
    border-radius: 1vw;
    width: 15vw;
   margin: 0.4vw ;
}

button:disabled,
button[disabled]{
    color: var(--body-colour);
    background-color: var(--disabled-button-background);
}
    </style>
</head>

<body>
    <dialog id="confirm">
      <div>
        <h3 id="confirm_title" class="dialog_text">Confirm Title</h3>
        <div id="confirm_button_bar">
          <button id="confirm_ok" class="accept">OK</button>
          <button id="confirm_cancel" class="decline">Annuleer</button>
        </div>
      </div>
    </dialog>

    <div id="screen">
      <div id="topContainer">
        <h1 id="handString"></h1>
        <h3 id="displayString">Stand in ronde: </h3>
      </div>
      <table>
        <tr>
          <th>Naam:</th>
          <td><input id="Sp1Naam" type="text" value="Speler 1"></input></td>
          <td><input id="Sp2Naam" type="text" value="Speler 2"></input></td>
          <td><input id="Sp3Naam" type="text" value="Speler 3"></input></td>
          <td><input id="Sp4Naam" type="text" value="Speler 4"></input></td>
        </tr>
        <tr>
          <th>Geboden:</th>
          <td><input id="Sp1Geboden" type="number" min="0" step="1"></input></td>
          <td><input id="Sp2Geboden" type="number" min="0" step="1"></input></td>
          <td><input id="Sp3Geboden" type="number" min="0" step="1"></input></td>
          <td><input id="Sp4Geboden" type="number" min="0" step="1"></input></td>
        </tr>
        <tr>
          <th>Gehaald:</th>
          <td><input id="Sp1Gehaald" type="number" min="0" step="1"></input></td>
          <td><input id="Sp2Gehaald" type="number" min="0" step="1"></input></td>
          <td><input id="Sp3Gehaald" type="number" min="0" step="1"></input></td>
          <td><input id="Sp4Gehaald" type="number" min="0" step="1"></input></td>
        </tr>
        <tr>
          <th>Score:</th>
          <td><input id="Sp1Score" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp2Score" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp3Score" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp4Score" type="number" min="0" step="1" disabled></input></td>
        </tr>
        <tr>
          <th>Stand:</th>
          <td><input id="Sp1Stand" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp2Stand" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp3Stand" type="number" min="0" step="1" disabled></input></td>
          <td><input id="Sp4Stand" type="number" min="0" step="1" disabled></input></td>
        </tr>
      </table>
      <div id="buttonBar">
        <button id="backButton">&lt&lt</button>
        <button id="calcButton">Bereken</button>
        <button id="newButton">Volgende</button>
        <button id="nextButton">&gt&gt</button>
      </div>
      <div id="gameButtonBar">
        <button id="redoButton">Herstel</button>
        <button id="newGameButton">Nieuw spel</button>
      </div>
    </div>
    <div>
      <p id="versionString">v.1.0.0</p>
    </div>

    <script type="text/javascript">

const VERSION = "v.1.0.2" ;

//if ("serviceWorker" in navigator) {
//  navigator.serviceWorker.register("pwa_service.js").then(
//    (registration) => {
//      console.log("Service worker registration successful:", registration);
//    },
//    (error) => {
//      console.error(`Service worker registration failed: ${error}`);
//    },
//  );
//} else {
//  console.error("Service workers are not supported.");
//}

const backButton = document.querySelector("#backButton") ;
const calcButton = document.querySelector("#calcButton") ;
const newButton = document.querySelector("#newButton") ;
const nextButton = document.querySelector("#nextButton") ;
const newGameButton = document.querySelector("#newGameButton") ;
const cardsString = document.querySelector("#cardsString") ;
const handString = document.querySelector("#handString") ;
const versionString = document.querySelector("#versionString") ;
const name1String = document.querySelector("#Sp1Naam") ;
const name2String = document.querySelector("#Sp2Naam") ;
const name3String = document.querySelector("#Sp3Naam") ;
const name4String = document.querySelector("#Sp4Naam") ;

versionString.innerText = VERSION ;

//Hand

function new_hand(previous) {
  const hand = {
    bid: "",
    tricks: "",
    score: 0,
    total: 0,
    previous: previous,
    index: 0
  } ;
  if ( hand.previous !== null ) {
    hand.index = hand.previous.index+1 ;
    hand.total = hand.previous.total ;
  } 
  return hand ;
} 

function calculate_hand(hand) {
  if (hand.bid !== "") {
    hand.score = hand.tricks * 5 ;
    if ( hand.bid == hand.tricks ) {
      hand.score += (hand.index+1)*10 ;
    } 
  } 
  if ( hand.previous !== null ) {
    calculate_hand(hand.previous) ;
    hand.total = hand.previous.total + hand.score ;
  } else {
    hand.total = hand.score ;
  }
} 

function display_hand(hand, bidinput, tricksinput, scoreinput, totalinput) {
  bidinput.value = hand.bid ;
  tricksinput.value = hand.tricks ;
  scoreinput.value = hand.score ;
  totalinput.value = hand.total ;
}

function retrieve_hand(hand, bidinput, tricksinput) {
  hand.bid = parseInt(bidinput.value || "0", 10) ;
  hand.tricks = parseInt(tricksinput.value || "0", 10) ;
}

// PlayerHands

function new_playerhands() {
  return [new_hand(null)] ;
}

function calculate_playerhands(playerhands) {
  calculate_hand(playerhands[playerhands.length-1]) ;
}

function new_hand_playerhands(playerhands) {
  playerhands.push(new_hand(playerhands[playerhands.length-1])) ;
}

function display_playerhands(playerhands, prefix, displayed_hand) {
  display_hand(
    playerhands[displayed_hand],
    document.querySelector(prefix+"Geboden"),
    document.querySelector(prefix+"Gehaald"),
    document.querySelector(prefix+"Score"),
    document.querySelector(prefix+"Stand"),
  ) ;
}

function retrieve_playerhands(playerhands, prefix, displayed_hand) {
  retrieve_hand(
    playerhands[displayed_hand],
    document.querySelector(prefix+"Geboden"),
    document.querySelector(prefix+"Gehaald")
  ) ;
}

function remove_linked_hands(playerhands) {
  playerhands.forEach(
    function(hand) {
      hand.previous = null ;
    }
  ) ;
}

function restore_linked_hands(playerhands) {
  playerhands.forEach(
    function(hand, idx, hands) {
      if (idx > 0) {
        hand.previous = hands[idx-1] ;
      }
    }
  ) ;
}

// QuantumBridge

function new_quantumbridge() {
  const quantumbridge = {
    max_hands: 13,
    cards_in_first_hand: 1,
    displayed_hand: 0,
    name1: "Speler 1",
    name2: "Speler 2",
    name3: "Speler 3",
    name4: "Speler 4",
    player1: null,
    player2: null,
    player3: null,
    player4: null
  } ;

  reset_quantumbridge(quantumbridge) ;
  return quantumbridge ;
}

function reset_quantumbridge(qb) {
  qb.player1 = new_playerhands() ;
  qb.player2 = new_playerhands() ;
  qb.player3 = new_playerhands() ;
  qb.player4 = new_playerhands() ;
  qb.displayed_hand = 0 ;
  display_quantumbridge(qb) ;
}

function size_quantumbridge(qb) {
    return qb.player1.length ;
}

function calculate_quantumbridge(qb) {
  retrieve_quantumbridge(qb) ;
  calculate_playerhands(qb.player1) ;
  calculate_playerhands(qb.player2) ;
  calculate_playerhands(qb.player3) ;
  calculate_playerhands(qb.player4) ;
  save_quantumbridge(qb) ;
  display_quantumbridge(qb) ;
}

function new_hand_quantumbridge(qb) {
  if (size_quantumbridge(qb) < qb.max_hands) {
    new_hand_playerhands(qb.player1) ;
    new_hand_playerhands(qb.player2) ;
    new_hand_playerhands(qb.player3) ;
    new_hand_playerhands(qb.player4) ;
  }
  qb.displayed_hand = size_quantumbridge(qb) - 1 ;
  save_quantumbridge(qb) ;
  display_quantumbridge(qb) ;
}

function display_quantumbridge(qb) {
  handString.innerText = "Huidige ronde: "+ size_quantumbridge(qb) + " kaart(en)" ;
  displayString.innerText = "Overzicht ronde "+(qb.displayed_hand+1)+":" ;
  name1String.value = qb.name1 ;
  name2String.value = qb.name2 ;
  name3String.value = qb.name3 ;
  name4String.value = qb.name4 ;
  display_playerhands(qb.player1, "#Sp1", qb.displayed_hand) ;
  display_playerhands(qb.player2, "#Sp2", qb.displayed_hand) ;
  display_playerhands(qb.player3, "#Sp3", qb.displayed_hand) ;
  display_playerhands(qb.player4, "#Sp4", qb.displayed_hand) ;
  enable_buttons_quantumbridge(qb) ;
}

function retrieve_quantumbridge(qb) {
  qb.name1 = name1String.value ;
  qb.name2 = name2String.value ;
  qb.name3 = name3String.value ;
  qb.name4 = name4String.value ;
  retrieve_playerhands(qb.player1, "#Sp1", qb.displayed_hand) ;
  retrieve_playerhands(qb.player2, "#Sp2", qb.displayed_hand) ;
  retrieve_playerhands(qb.player3, "#Sp3", qb.displayed_hand) ;
  retrieve_playerhands(qb.player4, "#Sp4", qb.displayed_hand) ;
}

function enable_buttons_quantumbridge(qb) {
  if (qb.displayed_hand == (size_quantumbridge(qb) - 1)) {
    calcButton.disabled = false ;
    newButton.disabled = false ;
    redoButton.disabled = true ;
  } else {
    calcButton.disabled = true ;
    newButton.disabled = true ;
    redoButton.disabled = false ;
  }
}

function display_next_quantumbridge(qb) {
  if (qb.displayed_hand < qb.player1.length - 1 ) {
    qb.displayed_hand += 1 ;
  }
  enable_buttons_quantumbridge(qb) ;
  display_quantumbridge(qb) ;
}

function display_previous_quantumbridge(qb) {
  if (qb.displayed_hand > 0) {
    qb.displayed_hand -= 1 ;
  }
  enable_buttons_quantumbridge(qb) ;
  display_quantumbridge(qb) ;
}

function remove_linked_hands_quantumbridge(qb) {
  remove_linked_hands(qb.player1) ;
  remove_linked_hands(qb.player2) ;
  remove_linked_hands(qb.player3) ;
  remove_linked_hands(qb.player4) ;
}

function restore_linked_hands_quantumbridge(qb) {
  restore_linked_hands(qb.player1) ;
  restore_linked_hands(qb.player2) ;
  restore_linked_hands(qb.player3) ;
  restore_linked_hands(qb.player4) ;
}

function closeDialog(dialog) {
    dialog.style.display = 'none' ;
    dialog.close() ; 
}

function showConfirmDialog(config, accept, reject) {

    var titleTxt = config.title || 'Confirm?' ;
    var okTxt = config.ok || 'Ja' ;
    var cancelTxt = config.cancel || 'Nee' ;

    var dialog = document.querySelector('#confirm') ;
    var title = document.querySelector('#confirm_title') ;
    var ok_button = document.querySelector('#confirm_ok') ;
    var cancel_button = document.querySelector('#confirm_cancel') ;

    title.innerText = titleTxt ;
    ok_button.innerText = okTxt ;
    cancel_button.innerText = cancelTxt ;

    ok_button.onclick = function() {
        accept() ;
        closeDialog(dialog) ;
    } ;
    cancel_button.onclick = function() {
        reject() ;
        closeDialog(dialog) ;
    } ;

    dialog.style.display = 'flex' ;
    dialog.showModal() ;
}

function confirmDialog(config, accept, reject) {
    return new Promise(function() {
        showConfirmDialog(config, accept, reject) ;
    }) ;
}

var quantumBridge = new_quantumbridge() ;

function save_quantumbridge(qb) {
  retrieve_quantumbridge(qb) ;
  if (typeof(Storage) !== "undefined") {
    remove_linked_hands_quantumbridge(qb);
    localStorage.setItem(
      "quantumBridge", 
      JSON.stringify(qb)
    ) ;
    restore_linked_hands_quantumbridge(qb);
  }
}

function restore_quantumbridge() {
  if (typeof(Storage) !== "undefined") {
    if ("quantumBridge" in localStorage) {
      quantumBridge = JSON.parse(localStorage.getItem("quantumBridge")) ;
      restore_linked_hands_quantumbridge(quantumBridge);
      display_quantumbridge(quantumBridge)
    }
  }
}

backButton.onclick = function() {
  display_previous_quantumbridge(quantumBridge) ;
} ;

calcButton.onclick = function() {
  calculate_quantumbridge(quantumBridge) ;
} ;

newButton.onclick = function() {
  new_hand_quantumbridge(quantumBridge) ;
} ;

nextButton.onclick = function () {
  display_next_quantumbridge(quantumBridge) ;
} ;

redoButton.onclick = function () {
  calcButton.disabled = false ;
  newButton.disabled = false ;
} ;

newGameButton.onclick = function () {
  confirmDialog(
    {
      title: "Huidig spel verwijderen en opnieuw beginnen?",
      ok: "Ja",
      cancel: "Nee"
    },
      function () {
      	reset_quantumbridge(quantumBridge) ; 
        save_quantumbridge(qb) ;
      },
      function () {}
  ) ;
} ;

addEventListener("load", (event) => { restore_quantumbridge() ; })

    </script>
</body>
